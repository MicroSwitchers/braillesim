<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="format-detection" content="telephone=no">
    <meta name="msapplication-tap-highlight" content="no">
    
    <title>Braille Writer Simulator</title>
    <meta name="description" content="A mechanical Braille writer simulator for learning and practicing Braille writing techniques">
    <meta name="keywords" content="braille, writer, simulator, accessibility, education, tactile, mechanical">
    <meta name="author" content="Braille Writer Simulator">
    
    <!-- PWA Meta Tags -->
    <meta name="application-name" content="Braille Writer">
    <meta name="apple-mobile-web-app-title" content="Braille Writer">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#007c8a">
    <meta name="msapplication-navbutton-color" content="#007c8a">
    <meta name="msapplication-TileColor" content="#005f6b">
    <meta name="msapplication-starturl" content="./index.html">
    
    <!-- Web App Manifest -->
    <link rel="manifest" href="./manifest.json">
    
    <!-- Favicons and Icons -->
    <link rel="icon" type="image/svg+xml" href="./braillesim.svg">
    <link rel="icon" type="image/png" sizes="32x32" href="./icons/icon-96x96.png">
    <link rel="icon" type="image/png" sizes="16x16" href="./icons/icon-72x72.png">
    <link rel="shortcut icon" href="./braillesim.svg">
    
    <!-- Apple Touch Icons -->
    <link rel="apple-touch-icon" href="./icons/icon-192x192.png">
    <link rel="apple-touch-icon" sizes="72x72" href="./icons/icon-72x72.png">
    <link rel="apple-touch-icon" sizes="96x96" href="./icons/icon-96x96.png">
    <link rel="apple-touch-icon" sizes="128x128" href="./icons/icon-128x128.png">
    <link rel="apple-touch-icon" sizes="144x144" href="./icons/icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="./icons/icon-152x152.png">
    <link rel="apple-touch-icon" sizes="192x192" href="./icons/icon-192x192.png">
    <link rel="apple-touch-icon" sizes="384x384" href="./icons/icon-384x384.png">
    <link rel="apple-touch-icon" sizes="512x512" href="./icons/icon-512x512.png">
    
    <!-- Microsoft Tiles -->
    <meta name="msapplication-TileImage" content="./icons/icon-144x144.png">
    <meta name="msapplication-square70x70logo" content="./icons/icon-72x72.png">
    <meta name="msapplication-square150x150logo" content="./icons/icon-152x152.png">
    <meta name="msapplication-wide310x150logo" content="./icons/icon-384x384.png">
    <meta name="msapplication-square310x310logo" content="./icons/icon-512x512.png">
    
    <!-- Preload critical resources -->
    <link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js" as="script">
    
    <!-- Tone.js for sound generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>

    <style>
        /* General App Structure and Flex Layout */
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden; /* Prevent body scrolling */
            font-family: 'Inter', 'Segoe UI', Arial, sans-serif;
            background-color: #e0e0e0;
            color: #333;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        #braille-writer-app {
            display: flex;
            flex-direction: column;
            height: 100vh; /* Full viewport height */
            width: 100%;
            max-width: 820px;
            margin: 0 auto;
            background-color: #005f6b; /* Classic Perkins Blue/Green */
            background-image: linear-gradient(145deg, #007c8a, #004d56);
            border: 1px solid #003e46;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4), inset 0 2px 3px rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            overflow: hidden;
            transition: background-color 0.3s ease, border-color 0.3s ease;
            position: relative; /* Needed for positioning rotary handles */
        }
        
        #braille-writer-app:focus {
            outline: none;
        }

        * {
            box-sizing: border-box;
        }

        .card-header {
            padding: 12px 20px;
            border-bottom: 1px solid #004d56;
            background-color: rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }

        .card-title {
            font-size: 20px;
            font-weight: 700;
            margin: 0;
            text-align: left;
            text-shadow: 0 1px 1px rgba(0, 0, 0, 0.3);
            letter-spacing: 0.8px;
            color: #ffffff;
        }

        .header-buttons {
            display: flex;
            gap: 10px;
        }

        .small-button {
            font-size: 12px;
            background: linear-gradient(135deg, #e0e0e0, #cccccc);
            border: 1px solid #999;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 150ms ease-out;
            font-weight: 600;
            color: #333;
            text-shadow: 0 1px 0 rgba(255, 255, 255, 0.7);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2), inset 0 1px 1px rgba(255, 255, 255, 0.5);
        }

        .small-button:hover {
            background: linear-gradient(135deg, #f0f0f0, #d9d9d9);
            border-color: #888;
        }

        .small-button:active, .small-button.active {
            background: linear-gradient(135deg, #cccccc, #e0e0e0);
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.2), inset 0 1px 2px rgba(0, 0, 0, 0.2);
            transform: translateY(1px);
        }

        .install-button {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            border-color: #45a049;
        }

        .install-button:hover {
            background: linear-gradient(135deg, #5CBF60, #4CAF50);
        }

        .install-button.hidden {
            display: none;
        }

        /* Braille Grid */
        .braille-grid {
            flex-grow: 1; 
            overflow: auto;
            background-color: #f0e6d6; /* Buff paper color */
            border: 4px solid #c9c9c9;
            border-top-color: #aaa;
            border-left-color: #aaa;
            padding: 12px 8px;
            border-radius: 8px;
            margin: 16px;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.2);
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }

        .braille-row {
            display: flex;
            flex-wrap: nowrap;
            justify-content: flex-start;
            margin-bottom: 8px;
        }

        .braille-cell {
            display: inline-block;
            margin: 0 2px;
            width: 20px;
            height: 28px;
            position: relative;
            border: 1px solid transparent;
            flex-shrink: 0;
        }

        .braille-dot-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 3px;
            width: 100%;
            height: 100%;
            justify-items: center;
            align-items: center;
        }

        .braille-dot {
            width: 7px;
            height: 7px;
            border-radius: 50%;
            transition: all 0.1s ease-in-out;
        }

        .braille-dot-active {
            background: #4a4a4a;
            box-shadow: 0 1px 1px rgba(0,0,0,0.5), inset 0 1px 1px rgba(255,255,255,0.2);
            border: 1px solid #222;
        }

        .braille-dot-inactive {
            background: #e6dac8;
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.2);
        }

        .current-cell {
            background: rgba(0, 95, 107, 0.1);
            border-radius: 4px;
        }

        .current-cell::after {
            content: '';
            position: absolute;
            left: 0;
            right: 0;
            bottom: -3px;
            height: 3px;
            background: #007c8a;
            box-shadow: 0 0 6px #007c8a;
            border-radius: 2px;
            animation: cursorPulse 2s infinite ease-in-out;
            transition: background-color 0.3s ease;
        }

        @keyframes cursorPulse {
            50% { opacity: 0.7; }
        }

        /* Slider */
        .slider-container {
            margin: 0 16px 12px;
            padding: 6px 20px 6px 16px;
            border-radius: 6px;
            background: rgba(0,0,0,0.1);
            flex-shrink: 0;
            position: relative;
            transition: background-color 0.3s ease;
        }

        .slider {
            width: 100%;
            -webkit-appearance: none;
            appearance: none;
            height: 8px;
            background: #004d56;
            outline: none;
            border-radius: 4px;
            margin: 10px 0;
            box-shadow: inset 0 1px 4px rgba(0, 0, 0, 0.5);
            transition: background-color 0.3s ease;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 60px;
            height: 24px;
            background: linear-gradient(to bottom, #f0f0f0, #c0c0c0);
            cursor: pointer;
            border-radius: 4px;
            border: 1px solid #888;
            box-shadow: 0 1px 3px rgba(0,0,0,0.4);
        }

        .slider::-moz-range-thumb {
            width: 60px;
            height: 24px;
            background: linear-gradient(to bottom, #f0f0f0, #c0c0c0);
            cursor: pointer;
            border-radius: 4px;
            border: 1px solid #888;
        }
        
        .cell-count {
            position: absolute;
            bottom: -15px;
            right: 16px;
            font-size: 12px;
            color: #e0e0e0;
            text-shadow: 1px 1px 1px rgba(0,0,0,0.3);
        }

        /* Keys */
        .key-container {
            display: flex;
            justify-content: center;
            align-items: center;
            flex-wrap: nowrap;
            gap: 8px;
            padding: 16px 8px;
            margin: 0 16px 20px;
            border-radius: 16px;
            background: rgba(0,0,0,0.1);
            flex-shrink: 0;
            transition: background-color 0.3s ease;
        }

        .key {
            font-weight: 700;
            color: #e0e0e0;
            padding: 0.8em 0.6em;
            background: linear-gradient(135deg, #5a5a5a, #3a3a3a);
            border: 1px solid #222;
            border-bottom-color: #666;
            border-right-color: #666;
            border-radius: 0.75em;
            cursor: pointer;
            margin: 3px;
            transform-style: preserve-3d;
            transition: all 150ms ease-out;
            text-shadow: 0 1px 1px rgba(0, 0, 0, 0.5);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.4), inset 0 1px 1px rgba(255, 255, 255, 0.2);
            user-select: none;
            -webkit-user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        .key:hover {
            background: linear-gradient(135deg, #6a6a6a, #4a4a4a);
        }

        .key:active, .key.active {
            transform: translateY(2px);
            background: linear-gradient(135deg, #3a3a3a, #5a5a5a);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.4), inset 0 1px 2px rgba(0, 0, 0, 0.2);
        }

        .key.dot-key {
            width: 75px; 
            height: 75px;
            border-top-left-radius: 20px;
            border-top-right-radius: 20px;
            border-bottom-left-radius: 35px;
            border-bottom-right-radius: 35px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            font-size: 13px;
        }

        .space-key {
            width: 100px;
            height: 75px;
            border-radius: 20px;
        }

        .round-key {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 14px;
        }

        /* Instructions & Settings */
        .instructions-drawer {
            background: #004d56;
            border-top: 1px solid #007c8a;
            flex-shrink: 0;
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }

        .instructions-toggle {
            width: 100%;
            padding: 12px;
            background: rgba(0,0,0,0.2);
            border: none;
            border-bottom: 1px solid #003e46;
            color: #fff;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            outline: none;
            position: relative;
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }

        .instructions-toggle::after {
            content: '▲';
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            transition: transform 300ms ease;
            font-size: 14px;
        }

        .instructions-drawer.open .instructions-toggle::after {
            transform: translateY(-50%) rotate(180deg);
        }

        .instructions-content {
            padding: 0 20px;
            max-height: 0;
            overflow: hidden;
            transition: max-height 300ms ease, padding 300ms ease;
            color: #e0e0e0;
        }

        .instructions-drawer.open .instructions-content {
            max-height: 500px; /* Increased from 400px */
            overflow-y: auto;
            padding: 20px;
        }

        .instructions-content ul {
            list-style-type: none;
            padding: 0;
            margin: 0 0 15px 0;
        }

        .instructions-content li {
            background-color: rgba(0,0,0,0.1);
            margin: 8px 0;
            padding: 12px;
            border-radius: 6px;
        }

        .settings {
            background-color: rgba(0,0,0,0.1);
            border-radius: 10px;
            padding: 18px;
            margin-top: 15px;
            border: 1px solid #003e46;
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }

        select, input[type="range"], input[type="checkbox"] {
            background-color: #004d56;
            border: 1px solid #007c8a;
            color: #fff;
            padding: 6px;
            border-radius: 5px;
            outline: none;
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }

        input[type="checkbox"] {
            accent-color: #fff;
        }

        /* Eraser Mode */
        .braille-grid.erase-mode {
            cursor: crosshair;
        }

        .braille-grid.erase-mode .braille-dot-active:hover {
            box-shadow: 0 0 10px rgba(255, 0, 0, 0.6);
            transform: scale(1.1);
        }

        #erase-mode-btn.active {
            background-image: linear-gradient(to bottom, #ff5e5e, #ff3333 50%, #e62e2e);
            color: white;
            border-color: #ff3333;
        }

        /* Fullscreen Mode */
        #braille-writer-app.fullscreen-mode {
            max-width: 100%;
            height: 100vh;
            margin: 0;
            border-radius: 0;
            border: none;
        }
        
        /* High Contrast Dark Mode */
        #braille-writer-app.high-contrast-dark {
            background-color: #121212;
            background-image: none;
            border-color: #333;
        }
        #braille-writer-app.high-contrast-dark .card-header {
            background-color: #1e1e1e;
            border-bottom-color: #333;
        }
        #braille-writer-app.high-contrast-dark .card-title {
            color: #ffff00;
        }
        #braille-writer-app.high-contrast-dark .small-button {
            background: #333;
            border-color: #555;
            color: #ffff00;
            text-shadow: none;
            box-shadow: 0 2px 4px rgba(0,0,0,0.5), inset 0 1px 1px rgba(255,255,255,0.1);
        }
        #braille-writer-app.high-contrast-dark .small-button:hover {
            background: #444;
        }
        #braille-writer-app.high-contrast-dark .small-button:active {
            background: #222;
        }
        #braille-writer-app.high-contrast-dark .braille-grid {
            background-color: #000000;
            border-color: #444;
        }
        #braille-writer-app.high-contrast-dark .braille-dot-active {
            background: #ffff00;
            border-color: #ffff00;
            box-shadow: 0 0 5px #ffff00;
        }
        #braille-writer-app.high-contrast-dark .braille-dot-inactive {
            background: #222;
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.5);
        }
        #braille-writer-app.high-contrast-dark .current-cell {
            background: rgba(255, 255, 0, 0.1);
        }
        #braille-writer-app.high-contrast-dark .current-cell::after {
            background: #ffff00;
            box-shadow: 0 0 6px #ffff00;
        }
        #braille-writer-app.high-contrast-dark .slider-container,
        #braille-writer-app.high-contrast-dark .key-container {
            background: #1e1e1e;
        }
        #braille-writer-app.high-contrast-dark .slider {
            background: #000;
        }
        #braille-writer-app.high-contrast-dark .slider::-webkit-slider-thumb {
            background: #ffff00;
            border-color: #333;
        }
        #braille-writer-app.high-contrast-dark .cell-count {
            color: #ffff00;
        }
        #braille-writer-app.high-contrast-dark .key {
            background: #222;
            color: #ffff00;
            border-color: #444;
            box-shadow: 0 4px 8px rgba(0,0,0,0.7), inset 0 1px 1px rgba(255,255,255,0.1);
        }
        #braille-writer-app.high-contrast-dark .key:hover {
            background: #333;
        }
        #braille-writer-app.high-contrast-dark .key:active {
            background: #111;
        }
        #braille-writer-app.high-contrast-dark .instructions-drawer {
            background: #1e1e1e;
            border-top-color: #333;
        }
        #braille-writer-app.high-contrast-dark .instructions-toggle {
            background: #121212;
            border-bottom-color: #333;
            color: #ffff00;
        }
        #braille-writer-app.high-contrast-dark .instructions-content {
            color: #ffff00;
        }
        #braille-writer-app.high-contrast-dark .settings {
            background-color: #121212;
            border-color: #333;
        }
        #braille-writer-app.high-contrast-dark select,
        #braille-writer-app.high-contrast-dark input[type="range"],
        #braille-writer-app.high-contrast-dark input[type="checkbox"] {
            background-color: #000;
            border-color: #444;
            color: #ffff00;
        }
        #braille-writer-app.high-contrast-dark input[type="checkbox"] {
            accent-color: #ffff00;
        }
        
        /* Rotary Handles */
        .rotary-handle {
            position: absolute;
            top: 100px; /* Adjust vertical position */
            width: 20px; /* Made thinner */
            height: 60px;
            background: linear-gradient(135deg, #4a4a4a, #2a2a2a);
            border-radius: 6px;
            border: 1px solid #111;
            box-shadow: 0 2px 5px rgba(0,0,0,0.5), inset 0 1px 1px rgba(255,255,255,0.2);
            z-index: 10;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .rotary-handle.left-handle {
            left: -8px; /* Adjusted position */
        }
        .rotary-handle.right-handle {
            right: -8px; /* Adjusted position */
        }
        .handle-part {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background-color 0.1s ease;
            color: rgba(255,255,255,0.4);
            font-size: 12px;
        }
        .handle-part:hover {
            background-color: rgba(255,255,255,0.1);
        }
        .handle-part:active {
            background-color: rgba(0,0,0,0.2);
        }
        .handle-up {
            border-bottom: 1px solid rgba(0,0,0,0.3);
        }


        /* Responsive Design */
        @media (max-width: 840px) {
            .rotary-handle {
                display: none; /* Hide handles on smaller screens to avoid overlap */
            }
        }
        @media (max-width: 768px) {
            .key-container {
                flex-wrap: wrap;
                gap: 4px;
                padding: 10px 4px;
            }
            .key.dot-key { width: 65px; height: 65px; font-size: 11px; }
            .key.space-key { width: 80px; height: 65px; }
            .key.round-key { width: 48px; height: 48px; font-size: 12px; }
            .card-header { padding: 12px 15px; }
            .card-title { font-size: 18px; }
            .small-button { font-size: 11px; padding: 5px 10px; }
        }

        @media (max-width: 480px) {
            .key.dot-key { width: 55px; height: 55px; font-size: 10px; }
            .key.space-key { width: 70px; height: 55px; }
            .key.round-key { width: 42px; height: 42px; font-size: 11px; }
            .braille-grid { margin: 10px; }
            .slider-container { margin: 0 10px 10px; }
            .key-container { margin: 0 10px 10px; }
            
            /* Better drawer scrolling on mobile */
            .instructions-drawer.open .instructions-content {
                max-height: 300px; /* Smaller on mobile to leave room for other content */
            }
            
            .header-buttons {
                flex-wrap: wrap;
                gap: 5px;
            }
            
            .small-button {
                font-size: 10px;
                padding: 4px 8px;
            }
        }

        @media (max-height: 600px) {
            /* For very short screens, limit drawer height even more */
            .instructions-drawer.open .instructions-content {
                max-height: 250px;
            }
        }

    </style>
</head>
<body>
    <div id="braille-writer-app" class="card" tabindex="-1">
        <div class="rotary-handle left-handle">
            <div id="left-handle-up" class="handle-part handle-up">▲</div>
            <div id="left-handle-down" class="handle-part handle-down">▼</div>
        </div>
        <div class="rotary-handle right-handle">
            <div id="right-handle-up" class="handle-part handle-up">▲</div>
            <div id="right-handle-down" class="handle-part handle-down">▼</div>
        </div>
        <!-- Braille viewport at the top -->
        <div id="braille-grid" class="braille-grid"></div>
        
        <!-- Slider below viewport -->
        <div class="slider-container">
            <input type="range" id="slider" min="0" max="30" value="0" class="slider">
            <div id="cell-count" class="cell-count">Cell: 1 / 31</div>
        </div>
        
        <!-- Keys below slider -->
        <div class="key-container">
            <button class="key round-key" id="linespace-btn">LS (a)</button>
            <button class="key dot-key" id="dot3-btn">3 (s)</button>
            <button class="key dot-key" id="dot2-btn">2 (d)</button>
            <button class="key dot-key" id="dot1-btn">1 (f)</button>
            <button class="key space-key" id="space-btn">Space (G/H)</button>
            <button class="key dot-key" id="dot4-btn">4 (j)</button>
            <button class="key dot-key" id="dot5-btn">5 (k)</button>
            <button class="key dot-key" id="dot6-btn">6 (l)</button>
            <button class="key round-key" id="backspace-btn">BS (;)</button>
        </div>
        
        <!-- Instructions drawer -->
        <div id="instructions-drawer" class="instructions-drawer">
            <button id="instructions-toggle" class="instructions-toggle">Instructions & Settings</button>
            <div class="instructions-content">
                <ul>
                    <li><strong>Key-to-Dot Mapping:</strong> F=dot1, D=dot2, S=dot3, J=dot4, K=dot5, L=dot6</li>
                    <li><strong>Physical Layout:</strong> 3(S)-2(D)-1(F)-Space-4(J)-5(K)-6(L)</li>
                    <li><strong>Braille Pattern:</strong> 1-4 (top), 2-5 (middle), 3-6 (bottom)</li>
                    <li><strong>Space:</strong> G and/or H</li>
                    <li><strong>Line Spacer:</strong> A</li>
                    <li><strong>Backspacer:</strong> ;</li>
                    <li><strong>Carriage Lever:</strong> ← → Arrow keys or slider</li>
                    <li><strong>Braille Eraser:</strong> Erase Mode + click to flatten dots</li>
                    <li><strong>Paper feeder Knob:</strong> ↑ ↓ Arrows</li>
                </ul>
                <div class="settings">
                    <div class="bell-settings">
                        <label for="bell-warning">Warning Bell (spaces from end):</label>
                        <select id="bell-warning">
                            <option value="7" selected>7</option>
                            <option value="6">6</option>
                            <option value="5">5</option>
                            <option value="4">4</option>
                            <option value="3">3</option>
                        </select>
                    </div>
                    <div class="toggle-settings">
                        <label for="toggle-bell">Right Margin Bell:</label>
                        <input type="checkbox" id="toggle-bell" checked>
                    </div>
                    <div class="toggle-settings">
                        <label for="toggle-key-sound">Key Embossing Sound:</label>
                        <input type="checkbox" id="toggle-key-sound" checked>
                    </div>
                    <div class="volume-settings">
                        <label for="volume-control">Sound Volume:</label>
                        <input type="range" id="volume-control" min="0" max="100" value="20">
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Header with title and controls at the bottom -->
        <div class="card-header">
            <h2 id="braille-writer-simulator" class="card-title">Braille Writer Simulator</h2>
            <div class="header-buttons">
                <button id="install-btn" class="small-button install-button hidden">Install App</button>
                <button id="save-btn" class="small-button">Save</button>
                <button id="load-btn" class="small-button">Load</button>
                <button id="dark-mode-btn" class="small-button">Dark Mode</button>
                <button id="all-clear-btn" class="small-button">All Clear</button>
                <button id="erase-mode-btn" class="small-button">Erase Mode</button>
                <button id="fullscreen-btn" class="small-button">Full Screen</button>
            </div>
        </div>
    </div>

    <script>
        // --- Application Constants and State ---
        const ROWS = 20;
        const COLS = 31;
        const EMPTY_CELL = [0, 0, 0, 0, 0, 0]; // Dots 1-6

        const keyMap = {
            'f': 0, 'd': 1, 's': 2, 'j': 3, 'k': 4, 'l': 5,
            'g': 'space', 'h': 'space',
            'a': 'linespace', ';': 'backspace',
            'arrowup': 'up', 'arrowdown': 'down', 'arrowleft': 'left', 'arrowright': 'right'
        };

        const dotKeys = new Set(['f', 'd', 's', 'j', 'k', 'l']);
        const spaceKeys = new Set(['g', 'h']);
        const movementKeys = new Set(['arrowup', 'arrowdown', 'arrowleft', 'arrowright']);

        let grid = Array.from({ length: ROWS }, () => Array.from({ length: COLS }, () => [...EMPTY_CELL]));
        let cursor = { row: 0, col: 0 };
        let activeKeys = new Set();
        let clusterKeys = new Set(); // Tracks keys pressed in a single chord
        let isEraseMode = false;
        let isMouseDown = false;
        let movementInterval = null;
        let sliderTimeout = null;

        let bellWarningSpaces = 7;
        let previousBellWarningPosition = -1;
        let isBellEnabled = true;
        let isKeySoundEnabled = true;
        
        // --- Performance Optimization State ---
        let cellElements = []; // To hold references to the cell and dot DOM elements
        let lastCursor = { row: -1, col: -1 }; // To track the last cursor position for efficient updates

        // --- DOM Element References ---
        const brailleGrid = document.getElementById('braille-grid');
        const slider = document.getElementById('slider');
        const cellCount = document.getElementById('cell-count');
        const bellWarningSelect = document.getElementById('bell-warning');
        const toggleBell = document.getElementById('toggle-bell');
        const toggleKeySound = document.getElementById('toggle-key-sound');
        const volumeControl = document.getElementById('volume-control');
        const allClearBtn = document.getElementById('all-clear-btn');
        const eraseModeBtn = document.getElementById('erase-mode-btn');
        const fullscreenBtn = document.getElementById('fullscreen-btn');
        const saveBtn = document.getElementById('save-btn');
        const loadBtn = document.getElementById('load-btn');
        const darkModeBtn = document.getElementById('dark-mode-btn');
        const installBtn = document.getElementById('install-btn');
        const leftHandleUp = document.getElementById('left-handle-up');
        const leftHandleDown = document.getElementById('left-handle-down');
        const rightHandleUp = document.getElementById('right-handle-up');
        const rightHandleDown = document.getElementById('right-handle-down');

        // --- PWA Variables ---
        let deferredPrompt;
        let isInstalled = false;

        // --- Unicode Maps ---
        let brailleUnicodeMap = {};
        let unicodeBrailleMap = {};

        // --- Audio Synthesis with Tone.js ---
        let keySynth, bellSynth;

        function initializeAudio() {
            keySynth = new Tone.MembraneSynth({ pitchDecay: 0.01, octaves: 2, envelope: { attack: 0.001, decay: 0.2, sustain: 0.01, release: 0.2 } }).toDestination();
            keySynth.volume.value = -15;
            bellSynth = new Tone.Synth({ oscillator: { type: 'sine' }, envelope: { attack: 0.01, decay: 0.5, sustain: 0.1, release: 1 } }).toDestination();
            bellSynth.volume.value = -10;
            document.body.addEventListener('click', async () => { await Tone.start(); }, { once: true });
        }

        function playSound(soundType) {
            if (soundType === 'key' && isKeySoundEnabled) keySynth.triggerAttackRelease('C2', '8n');
            if (soundType === 'ding' && isBellEnabled) bellSynth.triggerAttackRelease('A5', '8n');
        }

        function updateVolume() {
            const volumeValue = parseInt(volumeControl.value, 10);
            const db = volumeValue === 0 ? -Infinity : (volumeValue / 100) * 40 - 40;
            if (keySynth) keySynth.volume.value = db;
            if (bellSynth) bellSynth.volume.value = db + 5;
        }

        // --- Core Application Logic ---
        function updateCellCount() {
            cellCount.textContent = `Cell: ${cursor.col + 1} / ${COLS}`;
        }

        function moveCursor(rowDelta, colDelta, rotate = false) {
            cursor.row = Math.max(0, Math.min(ROWS - 1, cursor.row + rowDelta));
            cursor.col = Math.max(0, Math.min(COLS - 1, cursor.col + colDelta));
            slider.value = cursor.col;
            updateCellCount();
            renderBrailleGrid();
            if (rotate) rotateSlider();
            checkBellWarning();
        }
        
        function handleAction(action) {
            switch (action) {
                case 'linespace':
                    moveCursor(1, 0); // Move down one line, same column
                    playSound('key');
                    break;
                case 'backspace':
                    if (cursor.col > 0) {
                        moveCursor(0, -1);
                        playSound('key');
                    }
                    break;
                case 'space':
                    moveCursor(0, 1);
                    playSound('key');
                    break;
                case 'up': moveCursor(-1, 0); break;
                case 'down': moveCursor(1, 0); break;
                case 'left': moveCursor(0, -1, true); break;
                case 'right': moveCursor(0, 1, true); break;
            }
        }

        function handleKeyDown(e) {
            const key = e.key.toLowerCase();
            // FIX: Check if e.target exists and has the 'matches' method before calling it.
            if (e.target && typeof e.target.matches === 'function' && e.target.matches('input, select')) {
                return;
            }
            e.preventDefault();
            const action = keyMap[key];

            if (action !== undefined && !activeKeys.has(key)) {
                activeKeys.add(key);
                clusterKeys.add(key); // Track key for chording

                if (typeof action === 'number') {
                    grid[cursor.row][cursor.col][action] = 1;
                    renderBrailleGrid();
                } else if (movementKeys.has(key)) {
                     handleAction(action);
                     startContinuousMovement(action);
                }
            }
        }

        function handleKeyUp(e) {
            const key = e.key.toLowerCase();
            const action = keyMap[key];

            if (action !== undefined) {
                activeKeys.delete(key);
                clearInterval(movementInterval);

                if (activeKeys.size === 0) {
                    const wasDotOrSpaceChord = Array.from(clusterKeys).some(k => dotKeys.has(k) || spaceKeys.has(k));
                    
                    if (wasDotOrSpaceChord) {
                        moveCursor(0, 1);
                        playSound('key');
                    } else if (action === 'linespace' || action === 'backspace') {
                        handleAction(action);
                    }
                    
                    clusterKeys.clear(); // Reset for next chord
                }
            }
        }
        
        function startContinuousMovement(action) {
            if (!movementKeys.has(action)) return;
            clearInterval(movementInterval);
            movementInterval = setInterval(() => handleAction(action), 100);
        }

        function checkBellWarning() {
            const warningPosition = COLS - bellWarningSpaces - 1;
            if (cursor.col === warningPosition && previousBellWarningPosition !== cursor.col) {
                playSound('ding');
                previousBellWarningPosition = cursor.col;
            }
            if (cursor.col !== warningPosition) {
                previousBellWarningPosition = -1;
            }
        }

        function rotateSlider() {
            clearTimeout(sliderTimeout);
            slider.classList.add('rotated');
            sliderTimeout = setTimeout(() => slider.classList.remove('rotated'), 500);
        }
        
        function eraseDot(rowIndex, colIndex, dotIndex) {
            if (grid[rowIndex][colIndex][dotIndex] === 1) {
                grid[rowIndex][colIndex][dotIndex] = 0;
                renderBrailleGrid();
            }
        }

        // --- OPTIMIZED Rendering ---

        function renderBrailleGrid() {
            requestAnimationFrame(() => {
                if (cellElements.length === 0) {
                    initialRender();
                } else {
                    updateRender();
                }
            });
        }

        function initialRender() {
            const fragment = document.createDocumentFragment();
            for (let i = 0; i < ROWS; i++) {
                const rowEl = document.createElement('div');
                rowEl.className = 'braille-row';
                const rowCells = [];
                for (let j = 0; j < COLS; j++) {
                    const cellEl = document.createElement('div');
                    cellEl.className = 'braille-cell';
                    
                    const dotContainer = document.createElement('div');
                    dotContainer.className = 'braille-dot-container';
                    
                    const dots = [];
                    [0, 3, 1, 4, 2, 5].forEach(dotIndex => {
                        const dotEl = document.createElement('div');
                        dotEl.className = 'braille-dot braille-dot-inactive';
                        dotEl.dataset.row = i;
                        dotEl.dataset.col = j;
                        dotEl.dataset.dotIndex = dotIndex;
                        dotContainer.appendChild(dotEl);
                        dots.push(dotEl);
                    });
                    
                    cellEl.appendChild(dotContainer);
                    rowEl.appendChild(cellEl);
                    rowCells.push({ cellEl, dots });
                }
                fragment.appendChild(rowEl);
                cellElements.push(rowCells);
            }
            brailleGrid.innerHTML = '';
            brailleGrid.appendChild(fragment);
            updateRender();
        }

        function updateRender() {
            if (lastCursor.row !== -1 && (lastCursor.row !== cursor.row || lastCursor.col !== cursor.col)) {
                if (cellElements[lastCursor.row] && cellElements[lastCursor.row][lastCursor.col]) {
                    cellElements[lastCursor.row][lastCursor.col].cellEl.classList.remove('current-cell');
                }
            }

            for (let i = 0; i < ROWS; i++) {
                for (let j = 0; j < COLS; j++) {
                    const cellData = grid[i][j];
                    const cellDOM = cellElements[i][j];
                    const dotOrder = [0, 3, 1, 4, 2, 5];
                    for(let k = 0; k < 6; k++) {
                        const dotIndex = dotOrder[k];
                        const dotEl = cellDOM.dots[k];
                        const shouldBeActive = cellData[dotIndex] === 1;
                        const isCurrentlyActive = dotEl.classList.contains('braille-dot-active');

                        if (shouldBeActive && !isCurrentlyActive) {
                            dotEl.classList.remove('braille-dot-inactive');
                            dotEl.classList.add('braille-dot-active');
                        } else if (!shouldBeActive && isCurrentlyActive) {
                            dotEl.classList.remove('braille-dot-active');
                            dotEl.classList.add('braille-dot-inactive');
                        }
                    }
                }
            }
            
            if (cellElements[cursor.row] && cellElements[cursor.row][cursor.col]) {
                cellElements[cursor.row][cursor.col].cellEl.classList.add('current-cell');
            }

            lastCursor.row = cursor.row;
            lastCursor.col = cursor.col;

            scrollToCursor();
        }
        
        function scrollToCursor() {
            const currentCell = brailleGrid.querySelector('.current-cell');
            if (currentCell) {
                currentCell.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'nearest' });
            }
        }
        
        // --- UI Feedback ---
        function showToast(message, isError = false) {
            const toast = document.createElement('div');
            toast.textContent = message;
            toast.style.position = 'fixed';
            toast.style.bottom = '20px';
            toast.style.left = '50%';
            toast.style.transform = 'translateX(-50%)';
            toast.style.backgroundColor = isError ? '#e62e2e' : '#4CAF50';
            toast.style.color = 'white';
            toast.style.padding = '12px 20px';
            toast.style.borderRadius = '8px';
            toast.style.zIndex = '10000';
            toast.style.opacity = '0';
            toast.style.transition = 'opacity 0.5s ease';
            document.body.appendChild(toast);
            setTimeout(() => { toast.style.opacity = '1'; }, 100);
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => { document.body.removeChild(toast); }, 500);
            }, 3000);
        }

        // --- Save and Load Functionality ---
        function generateBrailleUnicodeMaps() {
            for (let i = 0; i < 64; i++) { // 2^6 = 64 combinations for 6 dots
                const char = String.fromCharCode(0x2800 + i);
                const dots = [
                    (i & 1) ? 1 : 0,  // dot 1
                    (i & 2) ? 1 : 0,  // dot 2
                    (i & 4) ? 1 : 0,  // dot 3
                    (i & 8) ? 1 : 0,  // dot 4
                    (i & 16) ? 1 : 0, // dot 5
                    (i & 32) ? 1 : 0, // dot 6
                ];
                const key = dots.join('');
                brailleUnicodeMap[key] = char;
                unicodeBrailleMap[char] = dots;
            }
        }

        function saveBraille() {
            let unicodeString = '';
            for (let i = 0; i < ROWS; i++) {
                let line = '';
                for (let j = 0; j < COLS; j++) {
                    const key = grid[i][j].join('');
                    line += brailleUnicodeMap[key] || '⠀';
                }
                unicodeString += line + '\n';
            }
            
            const blob = new Blob([unicodeString.trimEnd()], { type: 'text/plain;charset=utf-8' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'braille_document.txt';
            a.style.display = 'none';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            showToast('Document saved!');
        }

        function loadBraille() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.txt';
            input.onchange = e => {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = event => {
                    try {
                        const text = event.target.result;
                        const lines = text.split('\n');
                        
                        const newGrid = Array.from({ length: ROWS }, () => Array.from({ length: COLS }, () => [...EMPTY_CELL]));
                        
                        for (let i = 0; i < Math.min(lines.length, ROWS); i++) {
                            for (let j = 0; j < Math.min(lines[i].length, COLS); j++) {
                                const char = lines[i][j];
                                if (unicodeBrailleMap[char]) {
                                    newGrid[i][j] = unicodeBrailleMap[char];
                                }
                            }
                        }
                        grid = newGrid;
                        cursor = { row: 0, col: 0 };
                        renderBrailleGrid();
                        showToast('Document loaded successfully!');
                    } catch (error) {
                        showToast('Failed to load file. Please check the format.', true);
                        console.error("Error loading file:", error);
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        // --- PWA Functionality ---
        function registerServiceWorker() {
            if ('serviceWorker' in navigator) {
                window.addEventListener('load', () => {
                    navigator.serviceWorker.register('./sw.js')
                        .then((registration) => {
                            console.log('SW registered: ', registration);
                            
                            // Check for updates
                            registration.addEventListener('updatefound', () => {
                                const newWorker = registration.installing;
                                newWorker.addEventListener('statechange', () => {
                                    if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                        showToast('App updated! Refresh to see changes.');
                                    }
                                });
                            });
                        })
                        .catch((registrationError) => {
                            console.log('SW registration failed: ', registrationError);
                        });
                });
            }
        }

        function handleInstallPrompt() {
            // Listen for beforeinstallprompt event
            window.addEventListener('beforeinstallprompt', (e) => {
                // Prevent Chrome 67 and earlier from automatically showing the prompt
                e.preventDefault();
                // Stash the event so it can be triggered later
                deferredPrompt = e;
                // Show install button
                installBtn.classList.remove('hidden');
            });

            // Handle install button click
            installBtn.addEventListener('click', async () => {
                if (deferredPrompt) {
                    // Show the install prompt
                    deferredPrompt.prompt();
                    
                    // Wait for the user to respond to the prompt
                    const { outcome } = await deferredPrompt.userChoice;
                    
                    if (outcome === 'accepted') {
                        console.log('User accepted the install prompt');
                        showToast('App is being installed...');
                    } else {
                        console.log('User dismissed the install prompt');
                        showToast('Installation cancelled');
                    }
                    
                    // Clear the deferredPrompt
                    deferredPrompt = null;
                    installBtn.classList.add('hidden');
                }
            });

            // Listen for app installed event
            window.addEventListener('appinstalled', (evt) => {
                console.log('App was installed');
                showToast('App installed successfully!');
                installBtn.classList.add('hidden');
                isInstalled = true;
                
                // Track installation analytics if needed
                if (typeof gtag !== 'undefined') {
                    gtag('event', 'pwa_install', {
                        'event_category': 'PWA',
                        'event_label': 'User installed the app'
                    });
                }
            });
        }

        function checkIfInstalled() {
            // Check if app is already installed
            if (window.matchMedia && window.matchMedia('(display-mode: standalone)').matches) {
                isInstalled = true;
                installBtn.classList.add('hidden');
                console.log('App is running in standalone mode');
            }
            
            // Check for iOS standalone mode
            if (window.navigator.standalone === true) {
                isInstalled = true;
                installBtn.classList.add('hidden');
                console.log('App is running in iOS standalone mode');
            }
        }

        function enableOfflineSupport() {
            // Handle online/offline status
            function updateOnlineStatus() {
                if (navigator.onLine) {
                    showToast('Back online!');
                } else {
                    showToast('App is now offline - your work is still saved locally', false);
                }
            }

            window.addEventListener('online', updateOnlineStatus);
            window.addEventListener('offline', updateOnlineStatus);
        }

        function handleUrlParameters() {
            // Handle URL parameters for PWA shortcuts
            const urlParams = new URLSearchParams(window.location.search);
            const action = urlParams.get('action');
            
            if (action === 'new') {
                // Clear the grid for new document
                grid = Array.from({ length: ROWS }, () => Array.from({ length: COLS }, () => [...EMPTY_CELL]));
                cursor = { row: 0, col: 0 };
                renderBrailleGrid();
                showToast('New document started');
            }
        }


        // --- Event Listeners Setup ---

        function setupEventListeners() {
            document.addEventListener('keydown', handleKeyDown);
            document.addEventListener('keyup', handleKeyUp);
            
            document.addEventListener('mousedown', () => { isMouseDown = true; });
            document.addEventListener('mouseup', () => { isMouseDown = false; });

            brailleGrid.addEventListener('mousedown', e => {
                if (isEraseMode && e.target.classList.contains('braille-dot')) {
                    const { row, col, dotIndex } = e.target.dataset;
                    eraseDot(parseInt(row), parseInt(col), parseInt(dotIndex));
                }
            });
            brailleGrid.addEventListener('mouseover', e => {
                if (isEraseMode && isMouseDown && e.target.classList.contains('braille-dot')) {
                     const { row, col, dotIndex } = e.target.dataset;
                    eraseDot(parseInt(row), parseInt(col), parseInt(dotIndex));
                }
            });

            allClearBtn.addEventListener('click', () => {
                grid = Array.from({ length: ROWS }, () => Array.from({ length: COLS }, () => [...EMPTY_CELL]));
                cursor = { row: 0, col: 0 };
                renderBrailleGrid();
            });

            eraseModeBtn.addEventListener('click', () => {
                isEraseMode = !isEraseMode;
                eraseModeBtn.classList.toggle('active', isEraseMode);
                brailleGrid.classList.toggle('erase-mode', isEraseMode);
            });

            fullscreenBtn.addEventListener('click', () => {
                const appElement = document.getElementById('braille-writer-app');
                if (!document.fullscreenElement) appElement.requestFullscreen().catch(err => console.error(err));
                else document.exitFullscreen();
            });
            document.addEventListener('fullscreenchange', () => {
                const appElement = document.getElementById('braille-writer-app');
                appElement.classList.toggle('fullscreen-mode', !!document.fullscreenElement);
                fullscreenBtn.textContent = document.fullscreenElement ? 'Exit Full Screen' : 'Full Screen';
            });
            
            saveBtn.addEventListener('click', saveBraille);
            loadBtn.addEventListener('click', loadBraille);

            darkModeBtn.addEventListener('click', () => {
                const appElement = document.getElementById('braille-writer-app');
                appElement.classList.toggle('high-contrast-dark');
                const isDarkMode = appElement.classList.contains('high-contrast-dark');
                darkModeBtn.textContent = isDarkMode ? 'Light Mode' : 'Dark Mode';
            });

            leftHandleUp.addEventListener('click', () => handleAction('up'));
            leftHandleDown.addEventListener('click', () => handleAction('down'));
            rightHandleUp.addEventListener('click', () => handleAction('up'));
            rightHandleDown.addEventListener('click', () => handleAction('down'));

            const keyButtonMap = {
                'dot1-btn': 'f', 'dot2-btn': 'd', 'dot3-btn': 's',
                'dot4-btn': 'j', 'dot5-btn': 'k', 'dot6-btn': 'l',
                'space-btn': 'g', 'linespace-btn': 'a', 'backspace-btn': ';'
            };
            Object.entries(keyButtonMap).forEach(([btnId, key]) => {
                const button = document.getElementById(btnId);
                if (button) {
                    const press = () => document.dispatchEvent(new KeyboardEvent('keydown', { key: key, bubbles: true }));
                    const release = () => document.dispatchEvent(new KeyboardEvent('keyup', { key: key, bubbles: true }));
                    button.addEventListener('mousedown', press);
                    button.addEventListener('mouseup', release);
                    button.addEventListener('mouseleave', release);
                    button.addEventListener('touchstart', (e) => { e.preventDefault(); press(); }, { passive: false });
                    button.addEventListener('touchend', (e) => { e.preventDefault(); release(); }, { passive: false });
                }
            });

            slider.addEventListener('input', e => {
                cursor.col = parseInt(e.target.value);
                updateCellCount();
                renderBrailleGrid();
                rotateSlider();
                checkBellWarning();
            });
            slider.addEventListener('change', () => { document.getElementById('braille-writer-app').focus(); });

            document.getElementById('instructions-toggle').addEventListener('click', function() { this.parentElement.classList.toggle('open'); });
            bellWarningSelect.addEventListener('change', e => { bellWarningSpaces = parseInt(e.target.value); });
            toggleBell.addEventListener('change', e => { isBellEnabled = e.target.checked; });
            toggleKeySound.addEventListener('change', e => { isKeySoundEnabled = e.target.checked; });
            volumeControl.addEventListener('input', updateVolume);
        }

        // --- Initialization ---
        function initialize() {
            generateBrailleUnicodeMaps();
            initializeAudio();
            renderBrailleGrid();
            setupEventListeners();
            updateVolume();
            
            // PWA Initialization
            registerServiceWorker();
            handleInstallPrompt();
            checkIfInstalled();
            enableOfflineSupport();
            handleUrlParameters();
            
            document.getElementById('braille-writer-app').focus();
            
            // Show welcome message on first load
            setTimeout(() => {
                if (!localStorage.getItem('braille-writer-welcomed')) {
                    showToast('Welcome to Braille Writer Simulator! This app works offline and can be installed.');
                    localStorage.setItem('braille-writer-welcomed', 'true');
                }
            }, 2000);
        }

        window.addEventListener('load', initialize);

    </script>
</body>
</html>
